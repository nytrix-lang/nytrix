#!/usr/bin/env python3
"""
Nytrix Info Converter
"""
import sys
import re

def handle_table(m):
    type_ = m.group(1)
    body = m.group(2).strip()
    body = re.sub(r'@item\s+(.*)', r'.TP\n.B \1', body)
    return body

def handle_itemize(m):
    body = m.group(1).strip()
    body = re.sub(r'@item\s+', r'.IP \(bu 4\n', body)
    return body

def convert_man(texi_path, man_name, section="1"):
    with open(texi_path, 'r') as f:
        content = f.read()

    def handle_ref(m):
        args = [a.strip() for a in m.group(1).split(',')]
        if len(args) >= 3 and args[2]:
            return f"\\fB{args[2]}\\fP({section})"
        if len(args) >= 1 and args[0]:
            return f"\\fB{args[0]}\\fP"
        return ""

    title = ""
    m = re.search(r'@settitle\s+(.*)', content)
    if m:
        title = m.group(1).strip()
    out = [f'.TH {man_name.upper()} {section} "" "{title}"']
    content = re.sub(r'\\input texinfo.*?\n', '', content)
    content = re.sub(r'@setfilename.*?\n', '', content)
    content = re.sub(r'@settitle.*?\n', '', content)
    copying = ""
    m = re.search(r'@copying\n(.*?)\n@end copying', content, re.DOTALL)
    if m:
        copying = m.group(1).strip()
        copying = re.sub(r'@copyright\{\}', '(C)', copying)
        content = re.sub(r'@copying\n.*?\n@end copying', '', content, flags=re.DOTALL)
    content = re.sub(r'@node.*?\n', '', content)
    content = re.sub(r'@menu\n.*?\n@end menu', '', content, flags=re.DOTALL)
    content = re.sub(r'@dircategory.*?\n', '', content)
    content = re.sub(r'@direntry\n.*?\n@end direntry', '', content, flags=re.DOTALL)
    content = re.sub(r'@titlepage\n.*?\n@end titlepage', '', content, flags=re.DOTALL)
    content = re.sub(r'@contents\n', '', content)
    content = re.sub(r'@appendix.*?\n', '', content)
    content = re.sub(r'@printindex.*?\n', '', content)
    m = re.search(r'@top\s+(.*)', content)
    if m:
        name_desc = m.group(1).strip()
        if ' - ' not in name_desc:
            name_desc = f"{man_name} - {name_desc}"
        content = re.sub(r'@top\s+.*', r'.SH NAME\n' + name_desc, content, count=1)
    content = re.sub(r'@chapter\s+(.*)', lambda m: f'.SH {m.group(1).upper()}', content)
    content = re.sub(r'@section\s+(.*)', lambda m: f'.SH {m.group(1).upper()}', content)
    content = re.sub(r'@subsection\s+(.*)', r'.SS \1', content)
    content = re.sub(r'@table\s+(@\w+)\n(.*?)\n@end table', handle_table, content, flags=re.DOTALL)
    content = re.sub(r'@table\s+(@asis)\n(.*?)\n@end table', handle_table, content, flags=re.DOTALL)
    content = re.sub(r'@itemize\s+@bullet\n(.*?)\n@end itemize', handle_itemize, content, flags=re.DOTALL)
    content = content.replace('@@', '\x03')
    content = content.replace('@{', '\x01')
    content = content.replace('@}', '\x02')
    content = re.sub(r'@code\{(.*?)\}', r'\\fB\1\\fP', content)
    content = re.sub(r'@command\{(.*?)\}', r'\\fB\1\\fP', content)
    content = re.sub(r'@file\{(.*?)\}', r'\\fI\1\\fP', content)
    content = re.sub(r'@var\{(.*?)\}', r'\\fI\1\\fP', content)
    content = re.sub(r'@emph\{(.*?)\}', r'\\fI\1\\fP', content)
    content = re.sub(r'@samp\{(.*?)\}', r'\\fI\1\\fP', content)
    content = re.sub(r'@option\{(.*?)\}', r'\\fB\1\\fP', content)
    content = re.sub(r'@env\{(.*?)\}', r'\\fB\1\\fP', content)    
    content = re.sub(r'@ref\{(.*?)\}', handle_ref, content)
    content = content.replace('\x01', '{')
    content = content.replace('\x02', '}')
    content = content.replace('\x03', '@')
    content = re.sub(r'@example\n(.*?)\n@end example', r'.nf\n\1\n.fi', content, flags=re.DOTALL)
    content = re.sub(r'@bye.*', '', content, flags=re.DOTALL)
    content = re.sub(r'^Next:.*$', '', content, flags=re.MULTILINE)
    content = re.sub(r'^Previous:.*$', '', content, flags=re.MULTILINE)
    content = re.sub(r'^Up:.*$', '', content, flags=re.MULTILINE)
    content = re.sub(r'^\s*\[Contents\]\s*\[Index\]\s*$', '', content, flags=re.MULTILINE)
    content = re.sub(r'\n{3,}', '\n\n', content)
    out.append(content.strip())
    if copying:
        out.append(".SH LICENSE")
        out.append(copying)
    return "\n".join(out)

def convert_md(texi_path, title):
    with open(texi_path, "r") as f:
        content = f.read()

    content = re.sub(r'\\input texinfo.*?\n', '', content)
    content = re.sub(r'@setfilename.*?\n', '', content)
    content = re.sub(r'@settitle.*?\n', '', content)
    content = re.sub(r'@copying\n.*?\n@end copying', '', content, flags=re.DOTALL)
    content = re.sub(r'@node.*?\n', '', content)
    content = re.sub(r'@menu\n.*?\n@end menu', '', content, flags=re.DOTALL)
    content = re.sub(r'@dircategory.*?\n', '', content)
    content = re.sub(r'@direntry\n.*?\n@end direntry', '', content, flags=re.DOTALL)
    content = re.sub(r'@titlepage\n.*?\n@end titlepage', '', content, flags=re.DOTALL)
    content = re.sub(r'@contents\n', '', content)
    content = re.sub(r'@appendix.*?\n', '', content)
    content = re.sub(r'@printindex.*?\n', '', content)
    content = re.sub(r'@top\s+.*\n', f'# {title}\n', content)

    content = re.sub(r'@chapter\s+(.*)', r'# \1', content)
    content = re.sub(r'@section\s+(.*)', r'## \1', content)
    content = re.sub(r'@subsection\s+(.*)', r'### \1', content)

    content = re.sub(r'@table\s+(@\w+)\n(.*?)\n@end table',
                     lambda m: re.sub(r'@item\s+(.*)', r'- `\1`', m.group(2).strip()) + "\n",
                     content, flags=re.DOTALL)
    content = re.sub(r'@itemize\s+@bullet\n(.*?)\n@end itemize',
                     lambda m: re.sub(r'@item\s+', r'- ', m.group(1).strip()),
                     content, flags=re.DOTALL)

    content = content.replace('@@', '\x03')
    content = content.replace('@{', '\x01')
    content = content.replace('@}', '\x02')
    content = re.sub(r'@code\{(.*?)\}', r'`\1`', content)
    content = re.sub(r'@command\{(.*?)\}', r'`\1`', content)
    content = re.sub(r'@file\{(.*?)\}', r'`\1`', content)
    content = re.sub(r'@var\{(.*?)\}', r'`\1`', content)
    content = re.sub(r'@emph\{(.*?)\}', r'*\1*', content)
    content = re.sub(r'@samp\{(.*?)\}', r'`\1`', content)
    content = re.sub(r'@option\{(.*?)\}', r'`\1`', content)
    content = re.sub(r'@env\{(.*?)\}', r'`\1`', content)
    content = re.sub(r'@ref\{(.*?)\}', r'\1', content)
    content = content.replace('\x01', '{')
    content = content.replace('\x02', '}')
    content = content.replace('\x03', '@')
    content = re.sub(r'@example\n(.*?)\n@end example', r'```text\n\1\n```', content, flags=re.DOTALL)
    content = re.sub(r'@bye.*', '', content, flags=re.DOTALL)
    content = re.sub(r'\n{3,}', '\n\n', content)
    content = re.sub(r'\n([#]{1,3} )', r'\n\n\1', content)
    return content.strip() + "\n"

if __name__ == "__main__":
    if len(sys.argv) < 3:
        print("Usage: conv <input.texi> <name> [--format=man|md]")
        sys.exit(1)
    fmt = "man"
    for arg in sys.argv[3:]:
        if arg.startswith("--format="):
            fmt = arg.split("=", 1)[1].strip()
    if fmt == "md":
        print(convert_md(sys.argv[1], sys.argv[2]))
    else:
        print(convert_man(sys.argv[1], sys.argv[2]))
