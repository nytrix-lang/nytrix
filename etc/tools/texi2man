#!/usr/bin/env python3
import sys
import re

def convert(texi_path, man_name, section="1"):
    with open(texi_path, 'r') as f:
        content = f.read()

    # Basic header
    title = ""
    m = re.search(r'@settitle\s+(.*)', content)
    if m:
        title = m.group(1).strip()
    
    out = [f'.TH {man_name.upper()} {section} "" "{title}"']
    
    # Strip texinfo header/footer
    content = re.sub(r'\\input texinfo.*?\n', '', content)
    content = re.sub(r'@setfilename.*?\n', '', content)
    content = re.sub(r'@settitle.*?\n', '', content)
    
    # Process copying block
    copying = ""
    m = re.search(r'@copying\n(.*?)\n@end copying', content, re.DOTALL)
    if m:
        copying = m.group(1).strip()
        copying = re.sub(r'@copyright\{\}', '(C)', copying)
        content = re.sub(r'@copying\n.*?\n@end copying', '', content, flags=re.DOTALL)

    # Process nodes/menus (remove them)
    content = re.sub(r'@node.*?\n', '', content)
    content = re.sub(r'@menu\n.*?\n@end menu', '', content, flags=re.DOTALL)
    
    # Strip more TeX/Info directives
    content = re.sub(r'@dircategory.*?\n', '', content)
    content = re.sub(r'@direntry\n.*?\n@end direntry', '', content, flags=re.DOTALL)
    content = re.sub(r'@titlepage\n.*?\n@end titlepage', '', content, flags=re.DOTALL)
    content = re.sub(r'@contents\n', '', content)
    content = re.sub(r'@appendix.*?\n', '', content)
    content = re.sub(r'@printindex.*?\n', '', content)
    
    # Process top/name
    m = re.search(r'@top\s+(.*)', content)
    if m:
        name_desc = m.group(1).strip()
        # Try to find a dash, if not, name is man_name
        if ' - ' not in name_desc:
            name_desc = f"{man_name} - {name_desc}"
        content = re.sub(r'@top\s+.*', r'.SH NAME\n' + name_desc, content, count=1)

    # Process titles/chapters/sections - Uppercase top level
    content = re.sub(r'@chapter\s+(.*)', lambda m: f'.SH {m.group(1).upper()}', content)
    content = re.sub(r'@section\s+(.*)', lambda m: f'.SH {m.group(1).upper()}', content)
    content = re.sub(r'@subsection\s+(.*)', r'.SS \1', content)
    
    # Process tables
    def handle_table(m):
        type_ = m.group(1)
        body = m.group(2).strip()
        # @item -> .TP\n.B
        body = re.sub(r'@item\s+(.*)', r'.TP\n.B \1', body)
        return body

    content = re.sub(r'@table\s+(@\w+)\n(.*?)\n@end table', handle_table, content, flags=re.DOTALL)
    content = re.sub(r'@table\s+(@asis)\n(.*?)\n@end table', handle_table, content, flags=re.DOTALL)

    # Process itemize
    def handle_itemize(m):
        body = m.group(1).strip()
        body = re.sub(r'@item\s+', r'.IP \(bu 4\n', body)
        return body
    content = re.sub(r'@itemize\s+@bullet\n(.*?)\n@end itemize', handle_itemize, content, flags=re.DOTALL)

    # Protect literal braces during style conversion
    content = content.replace('@@', '\x03')
    content = content.replace('@{', '\x01')
    content = content.replace('@}', '\x02')

    # Inline formatting
    # Text styles
    content = re.sub(r'@code\{(.*?)\}', r'\\fB\1\\fP', content)
    content = re.sub(r'@command\{(.*?)\}', r'\\fB\1\\fP', content)
    content = re.sub(r'@file\{(.*?)\}', r'\\fI\1\\fP', content)
    content = re.sub(r'@var\{(.*?)\}', r'\\fI\1\\fP', content)
    content = re.sub(r'@strong\{(.*?)\}', r'\\fB\1\\fP', content)
    content = re.sub(r'@emph\{(.*?)\}', r'\\fI\1\\fP', content)
    content = re.sub(r'@samp\{(.*?)\}', r'\\fI\1\\fP', content)
    content = re.sub(r'@option\{(.*?)\}', r'\\fB\1\\fP', content)
    content = re.sub(r'@env\{(.*?)\}', r'\\fB\1\\fP', content)
    
    # Refs
    def handle_ref(m):
        args = [a.strip() for a in m.group(1).split(',')]
        if len(args) >= 3 and args[2]:
            return f"\\fB{args[2]}\\fP({section})"
        if len(args) >= 1 and args[0]:
            return f"\\fB{args[0]}\\fP"
        return ""
    
    content = re.sub(r'@ref\{(.*?)\}', handle_ref, content)
    
    # Restore protected literals
    content = content.replace('\x01', '{')
    content = content.replace('\x02', '}')
    content = content.replace('\x03', '@')
    
    # Examples
    content = re.sub(r'@example\n(.*?)\n@end example', r'.nf\n\1\n.fi', content, flags=re.DOTALL)
    
    # Clean up
    content = re.sub(r'@bye.*', '', content, flags=re.DOTALL)
    
    # Clean up empty lines and whitespace
    content = re.sub(r'\n{3,}', '\n\n', content)
    
    out.append(content.strip())
    
    if copying:
        out.append(".SH LICENSE")
        out.append(copying)

    return "\n".join(out)

if __name__ == "__main__":
    if len(sys.argv) < 3:
        print("Usage: texi2man <input.texi> <man_name>")
        sys.exit(1)
    
    print(convert(sys.argv[1], sys.argv[2]))
