#!/usr/bin/env python3
"""
Nytrix Tidy Formatter
"""
import os,sys,subprocess,re

rx=re.compile(rb"[ \t]+(?=\n|\Z)")
TAB=b"   "
EXTS={".c",".h",".ny",".py",".md"}

def chunks(xs,n):
    for i in range(0,len(xs),n): yield xs[i:i+n]

def git_files(dirs):
    try: out=subprocess.check_output(["git","ls-files","-z","--",*dirs])
    except Exception: return None
    fs=[x.decode() for x in out.split(b"\0") if x]
    return [f for f in fs if not f.startswith(".") and "/." not in f]

def walk_files(dirs):
    fs=[]
    for d in dirs:
        if not os.path.isdir(d): continue
        for r,ds,ns in os.walk(d):
            ds[:]=[x for x in ds if not x.startswith(".")]
            for n in ns:
                if n.startswith("."): continue
                p=os.path.join(r,n)
                if "/." in p: continue
                fs.append(p)
    return fs

def norm(p,tab3):
    b=open(p,"rb").read()
    nb=b.replace(b"\r",b"")
    if tab3: nb=nb.replace(b"\t",TAB)
    nb=rx.sub(b"",nb)
    if nb!=b: open(p,"wb").write(nb); return 1
    return 0

def main():
    dirs=sys.argv[1:] or ["src","std","etc/examples"]
    fs=git_files(dirs) or walk_files(dirs)

    ch=[f for f in fs if os.path.splitext(f)[1] in {".c",".h"}]
    for c in chunks(ch,256):
        subprocess.run(["clang-format","-i",*c],check=False)

    changed=0
    for f in fs:
        if os.path.splitext(f)[1] in EXTS:
            changed+=norm(f,True)

    if os.path.isfile("Makefile"):
        changed+=norm("Makefile",False)

    return 0

if __name__=="__main__": raise SystemExit(main())
